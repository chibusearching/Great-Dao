<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Great Dao</title>
  <style>
    body { font-family:sans-serif; background:#181826; color:#fff; text-align:center; }
    .container { margin:32px auto; padding:24px 32px; background:#282840; border-radius:12px; display:inline-block; }
    .section { margin:18px 0; }
    .stats { font-size:1.1em; margin-bottom:14px; }
    button { margin:6px 10px; padding:8px 20px; background:#7e3ff2; color:#fff; border:none; border-radius:6px; cursor:pointer;}
    button:disabled { background:#444; color:#ccc; cursor:not-allowed;}
    .idle { margin-top:14px; color:#ffd86b; }
    .event { margin-top:12px; font-style:italic; color:#5cf2b2;}
    .breakthrough { margin-top:16px; color:#e6aaff; font-weight:bold;}
    .stage { margin-top:10px; font-size:1.1em; }
    .legacy { margin:18px 0; background:#222; padding:18px; border-radius:8px; }
    .npc-panel { background:#232340; margin:6px 0; padding:8px; border-radius:8px; text-align:left;}
    .npc-rival { color:#f86e6e;}
    .npc-ally { color:#70e3e3;}
    .npc-family { color:#ffd9a0; }
    .npc-love { color:#ff8be2;}
    .npc-mentor { color:#8be2ff; }
    .npc-disciple { color:#b8ff8b; }
    .npc-bar { display:inline-block; width:80px; height:12px; border-radius:6px; margin:0 6px; background:#333; vertical-align:middle;}
    .npc-bar-inner { height:12px; border-radius:6px; }
    #worldEventBanner { margin:24px 0; background:#333; color:#ffd86b; font-size:1.12em; padding:12px; border-radius:8px; display:none; }
    #quizModal { display:none; position:fixed; top:0;left:0;width:100vw;height:100vh; background:rgba(0,0,0,0.85); z-index:999; }
    #quizModal .quiz-content { background:#222; padding:24px; margin:80px auto; max-width:400px; border-radius:12px; box-shadow:0 2px 16px #8e44ad; color: #fff; text-align:left;}
    #quizModal h2 { color: #ffd86b; }
    #quizQuestions label { margin-right: 14px; }
    #quizStatus { margin-top:14px; }
    .quest { color:#e3a95f; }
    .descendant { color:#bbffbb; }
    .ancestor { color:#ffd9a0; }
    .npc-actions { margin:6px 0 0 0;}
    .npc-actions button { background:#444; color:#ffd86b; font-size:0.95em; margin:2px 4px; padding:2px 8px;}
    .npc-actions button.active { background:#7e3ff2; color:#fff;}
    .npc-details { font-size:0.94em; }
    #npcPanel { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(20,20,40,0.96); z-index:998; }
    #npcPanelContent { background:#2a2a45; padding:24px; margin:60px auto; max-width:550px; border-radius:14px; box-shadow:0 2px 16px #8e44ad; color: #fff; text-align:left;}
    #closeNpcPanel { margin-bottom:18px; background:#f86e6e;}
    #npcPanel h2 { color: #ffd86b; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Great Dao</h1>
    <div class="section stats">
      Age: <span id="ageDisplay"></span> | Health: <span id="healthDisplay"></span> | Talent: <span id="talentDisplay"></span><br>
      Relationships: <span id="relDisplay"></span> | Wealth: <span id="wealthDisplay"></span>
    </div>
    <div class="section">
      <button id="studyBtn">Study</button>
      <button id="trainBtn">Train</button>
      <button id="workBtn">Work</button>
      <button id="restBtn">Rest</button>
      <button id="meetBtn">Meet NPC</button>
      <button id="cultivateBtn">Meditate</button>
      <button id="advanceBtn" disabled>Advance</button>
      <button id="relationshipBtn">Relationships</button>
    </div>
    <div class="section idle">
      Qi: <span id="qiDisplay"></span> | Qi/sec: <span id="qpsDisplay"></span>
      <div class="stage">
        Realm: <span id="realmDisplay"></span>
        <br>
        Stage: <span id="miniStageDisplay"></span>
      </div>
    </div>
    <div class="breakthrough" id="breakthroughMsg"></div>
    <div class="event" id="eventMsg"></div>
    <div id="worldEventBanner"></div>
    <div class="legacy" id="legacyPanel">
      <strong class="ancestor">Lineage Legacy:</strong>
      <div id="familyTree"></div>
      <div id="inheritedQuests"></div>
    </div>
  </div>
  <!-- NPC Relationship Panel Modal -->
  <div id="npcPanel">
    <div id="npcPanelContent">
      <button id="closeNpcPanel">Close</button>
      <h2>Your Relationships</h2>
      <div id="knownNpcList"></div>
    </div>
  </div>
  <!-- Quiz Modal -->
  <div id="quizModal">
    <div class="quiz-content">
      <h2 id="quizTitle">Breakthrough Quiz</h2>
      <div id="quizQuestions"></div>
      <button id="quizSubmitBtn">Submit Answers</button>
      <div id="quizStatus"></div>
    </div>
  </div>
  <script>
    // ==== Cultivation Stages ====
    const mainRealms = [
      "Third Rate Master", "Second Rate Master", "First Rate Master", "Peak Master", "Three Flowers Gather at the Summit",
      "Five Energies Converging at the Origin", "Ultimate Pinnacle", "Beyond the Path to Heaven (First Stage of Manifestation)",
      "Treading Heaven Beyond the Path (Second Stage of Manifestation)", "Beyond Treading Heavens (Third Stage of Manifestation)",
      "Fourth Stage of Manifestation", "Fifth Stage of Manifestation", "Qi Gathering", "Qi Refining",
      "Qi Building", "Core Formation", "Nascent Soul", "Heavenly Being", "Middle Boundary: Four Pillars",
      "Middle Boundary: Integration", "Middle Boundary: Star Shattering", "Middle Boundary: Star Rebirth",
      "Middle Boundary: Entering Nirvana", "Great Boundary: True Immortal"
    ];
    const miniStages = ["Early", "Middle", "Late", "Peak"];
    const qiNeeded = [
      [100, 200, 400, 700], [1200, 1800, 2400, 3200], [5000, 7000, 9000, 12000], [20000, 25000, 32000, 40000],
      [60000, 80000, 110000, 150000], [220000, 260000, 300000, 340000], [400000, 500000, 600000, 700000],
      [800000, 900000, 1050000, 1200000], [1500000, 1800000, 2100000, 2500000], [3000000, 3500000, 4000000, 4500000],
      [5000000, 6000000, 7000000, 8000000], [10000000, 12000000, 14000000, 16000000], [20000000, 22000000, 24000000, 26000000],
      [30000000, 35000000, 40000000, 45000000], [50000000, 60000000, 70000000, 80000000],
      [100000000, 120000000, 140000000, 160000000], [200000000, 220000000, 240000000, 260000000],
      [300000000, 350000000, 400000000, 450000000], [500000000, 600000000, 700000000, 800000000],
      [1000000000, 1200000000, 1400000000, 1600000000], [2000000000, 2200000000, 2400000000, 2600000000],
      [3000000000, 3500000000, 4000000000, 4500000000], [5000000000, 6000000000, 7000000000, 8000000000],
      [10000000000, 12000000000, 14000000000, 16000000000]
    ];

    // ==== World Events ====
    const worldEvents = [
      { name: "Qi Storm", effect: "All Qi/sec halved for 30 seconds", duration: 30, apply: () => { qiSecMod = 0.5; }, clear: () => { qiSecMod = 1; } },
      { name: "Demon Invasion", effect: "NPCs may lose talent; you must donate Qi to repel", duration: 45, apply: () => { demonActive = true; }, clear: () => { demonActive = false; } },
      { name: "Heavenly Tribulation", effect: "Breakthroughs require extra quiz; failing causes setback", duration: 40, apply: () => { tribulationActive = true; }, clear: () => { tribulationActive = false; } },
      { name: "Dao Fragment Shower", effect: "Talent bonus for all descendants", duration: 20, apply: () => { talentBonusActive = true; }, clear: () => { talentBonusActive = false; } }
    ];

    // ==== Quiz Pool ====
    const quizPools = [
      { q: "What is most important in human relationships?", a: "Trust", choices: ["Trust","Power","Wealth","Fame"] },
      { q: "Which emotion is hardest to control?", a: "Anger", choices: ["Joy","Anger","Hope","Fear"] },
      { q: "What is the foundation of a harmonious society?", a: "Respect", choices: ["Respect","Strength","Control","Obedience"] },
      { q: "To forgive is to ...", a: "Be free", choices: ["Be weak","Be free","Lose","Forget"] },
      { q: "Greatest virtue in a leader?", a: "Compassion", choices: ["Compassion","Wisdom","Charisma","Authority"] },
      { q: "Human ambition leads to ...", a: "Progress", choices: ["Progress","Destruction","Greed","War"] },
      { q: "What cultivates mental resilience?", a: "Meditation", choices: ["Meditation","Competition","Luck","Strength"] },
      { q: "Greatest obstacle for a cultivator's mind?", a: "Doubt", choices: ["Doubt","Greed","Pain","Laziness"] },
      { q: "A quiet mind brings ...", a: "Clarity", choices: ["Clarity","Power","Chaos","Loneliness"] },
      { q: "Wisdom is gained through ...", a: "Experience", choices: ["Experience","Books","Luck","Wealth"] },
      { q: "What defines one's Dao?", a: "Choices", choices: ["Choices","Power","Wealth","Followers"] },
      { q: "True enlightenment is found in?", a: "Understanding", choices: ["Understanding","Victory","Isolation","Conflict"] },
      { q: "What is the greatest test on the path?", a: "Sacrifice", choices: ["Sacrifice","Strength","Speed","Companions"] }
    ];

    // ==== Relationship System ====
    const npcTypes = [
      {type:"rival", label:"Rival", color:"npc-rival"},
      {type:"ally", label:"Ally", color:"npc-ally"},
      {type:"family", label:"Family", color:"npc-family"},
      {type:"love", label:"Love Interest", color:"npc-love"},
      {type:"mentor", label:"Mentor", color:"npc-mentor"},
      {type:"disciple", label:"Disciple", color:"npc-disciple"}
    ];
    const npcNames = [
      "Zhou", "Mei", "Chen", "Li", "Xiao", "Wang", "Yu", "Tian", "Luo", "Fang", "Qin", "Hua", "Lan", "Jin", "Rong", "Bo", "Wei", "Shen", "Min", "Yan"
    ];
    const npcTraits = [
      "Loyal", "Ambitious", "Hot-headed", "Wise", "Jealous", "Generous", "Secretive", "Bold", "Kind", "Scheming", "Righteous", "Detached"
    ];

    function randomFrom(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
    function clamp(val,min,max) { return Math.max(min,Math.min(max,val)); }

    // ==== Generational/Legacy State ====
    let familyTree = [];
    let inheritedQuests = [];
    let currentGeneration = 1;
    let parentName = "";
    let descendantName = "";
    let talentBonusActive = false;

    // ==== Player State ====
    let player = {
      name: "You",
      age: 16,
      health: 100,
      talent: 2,
      relationships: 0,
      wealth: 50,
      qi: 0,
      qiPerSec: 1,
      realmIndex: 0,
      miniStageIndex: 0,
      quests: [],
      alive: true
    };

    // ==== NPC Pool & Known NPCs ====
    let npcPool = [];
    let knownNPCs = [];
    function createNPC(index) {
      let typeObj = randomFrom(npcTypes);
      return {
        id: "npc-"+index+"-"+currentGeneration+"-"+Math.floor(Math.random()*10000),
        name: randomFrom(npcNames)+" "+(Math.random()<0.4 ? randomFrom(npcNames) : ""),
        type: typeObj.type,
        label: typeObj.label,
        color: typeObj.color,
        trait: randomFrom(npcTraits),
        relationship: clamp(Math.floor(Math.random()*60)+20,0,100),
        talent: clamp(Math.floor(Math.random()*4)+1,1,6),
        age: Math.floor(Math.random()*30)+14,
        qi: Math.floor(Math.random()*150),
        qiPerSec: 1,
        realmIndex: Math.floor(Math.random()*3),
        miniStageIndex: Math.floor(Math.random()*2),
        alive: true,
        married: false,
        spouseId: null,
        history: [],
      };
    }
    function generateNPCPool(n=12) {
      npcPool = [];
      knownNPCs = [];
      for (let i=0;i<n;i++) npcPool.push(createNPC(i));
    }
    generateNPCPool();

    // ==== World Event State ====
    let currentWorldEvent = null;
    let worldEventTimer = 0;
    let qiSecMod = 1;
    let demonActive = false;
    let tribulationActive = false;

    // ==== UI Elements ====
    const ageDisplay = document.getElementById('ageDisplay');
    const healthDisplay = document.getElementById('healthDisplay');
    const talentDisplay = document.getElementById('talentDisplay');
    const relDisplay = document.getElementById('relDisplay');
    const wealthDisplay = document.getElementById('wealthDisplay');
    const qiDisplay = document.getElementById('qiDisplay');
    const qpsDisplay = document.getElementById('qpsDisplay');
    const realmDisplay = document.getElementById('realmDisplay');
    const miniStageDisplay = document.getElementById('miniStageDisplay');
    const advanceBtn = document.getElementById('advanceBtn');
    const eventMsg = document.getElementById('eventMsg');
    const breakthroughMsg = document.getElementById('breakthroughMsg');
    const worldEventBanner = document.getElementById('worldEventBanner');
    const familyTreeDiv = document.getElementById('familyTree');
    const inheritedQuestsDiv = document.getElementById('inheritedQuests');
    const npcPanel = document.getElementById('npcPanel');
    const npcPanelContent = document.getElementById('npcPanelContent');
    const knownNpcListDiv = document.getElementById('knownNpcList');
    const relationshipBtn = document.getElementById('relationshipBtn');
    const closeNpcPanelBtn = document.getElementById('closeNpcPanel');

    // Quiz modal
    const quizModal = document.getElementById('quizModal');
    const quizQuestionsDiv = document.getElementById('quizQuestions');
    const quizSubmitBtn = document.getElementById('quizSubmitBtn');
    const quizTitle = document.getElementById('quizTitle');
    const quizStatus = document.getElementById('quizStatus');

    // ==== Quiz Logic ====
    function getRandomQuizQuestions(n=3) {
      let arr = quizPools.slice();
      let out = [];
      while (out.length < n && arr.length > 0) {
        let idx = Math.floor(Math.random() * arr.length);
        out.push(arr.splice(idx,1)[0]);
      }
      return out;
    }
    function showQuiz(callback, tribulation=false) {
      quizTitle.textContent = tribulation ? "Heavenly Tribulation Quiz!" : "Major Breakthrough Quiz";
      const questions = getRandomQuizQuestions(tribulation ? 4 : 3);
      quizQuestionsDiv.innerHTML = '';
      quizStatus.textContent = '';
      questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.innerHTML = `<b>Q${i+1}:</b> ${q.q}<br>`;
        q.choices.forEach(choice => {
          div.innerHTML += `<label><input type="radio" name="quizQ${i}" value="${choice}"> ${choice}</label> `;
        });
        quizQuestionsDiv.appendChild(div);
      });
      quizModal.style.display = 'block';
      quizSubmitBtn.onclick = function() {
        let correct = 0;
        questions.forEach((q, i) => {
          const radios = document.getElementsByName(`quizQ${i}`);
          let answer = "";
          for (const r of radios) if (r.checked) answer = r.value;
          if (answer === q.a) correct++;
        });
        quizStatus.textContent = `You got ${correct}/${questions.length} correct!`;
        setTimeout(() => {
          quizModal.style.display = 'none';
          callback(correct >= Math.ceil(questions.length/2));
        }, 1300);
      };
    }

    // ==== Life Actions ====
    document.getElementById('studyBtn').onclick = function() {
      if (player.wealth >= 5) {
        player.wealth -= 5; player.talent += 1;
        eventMsg.textContent = "You studied hard! Talent increased.";
      } else {
        eventMsg.textContent = "Not enough wealth to study.";
      }
      updateUI();
    };
    document.getElementById('trainBtn').onclick = function() {
      player.health = Math.max(player.health - 3, 0); player.qiPerSec += player.talent;
      eventMsg.textContent = "You trained. Qi/sec increased by your talent.";
      updateUI();
    };
    document.getElementById('workBtn').onclick = function() {
      player.wealth += 15; player.health = Math.max(player.health - 2, 0);
      eventMsg.textContent = "You worked and earned money.";
      updateUI();
    };
    document.getElementById('restBtn').onclick = function() {
      player.health = Math.min(player.health + 6, 100);
      eventMsg.textContent = "You rested. Health restored.";
      updateUI();
    };
    document.getElementById('meetBtn').onclick = function() {
      // Reveal a random NPC not yet known
      let unknowns = npcPool.filter(npc=>!knownNPCs.some(k=>k.id===npc.id));
      if (unknowns.length > 0) {
        let npc = randomFrom(unknowns);
        knownNPCs.push(npc);
        player.relationships += 1;
        eventMsg.textContent = `You met ${npc.name}, a ${npc.label}. They are now in your life.`;
        npc.history.push(`Met player (+7)`);
      } else {
        eventMsg.textContent = "You have met all possible NPCs for this generation.";
      }
      updateUI();
    };
    document.getElementById('cultivateBtn').onclick = function() {
      player.health = Math.max(player.health - 1, 0); player.qiPerSec += Math.floor(player.talent/2);
      eventMsg.textContent = "You meditate, Qi/sec rises.";
      updateUI();
    };

    // ==== Advancement logic ====
    advanceBtn.onclick = function() {
      let nextQiNeeded = qiNeeded[player.realmIndex]?.[player.miniStageIndex] || 0;
      if (player.qi >= nextQiNeeded) {
        if (player.miniStageIndex === miniStages.length-1) {
          showQuiz(function(passed) {
            if (passed) {
              breakthroughMsg.textContent = `Quiz passed! You broke through to ${mainRealms[player.realmIndex+1] || "the peak!"}`;
              eventMsg.textContent = "A new realm opens before you.";
              player.qiPerSec += 5 * (player.realmIndex+1);
              player.miniStageIndex = 0;
              player.realmIndex++;
              if (talentBonusActive) {
                player.talent += 2;
              }
              inheritedQuests = inheritedQuests.filter(q => q.type !== "breakthrough" || q.realm !== mainRealms[player.realmIndex]);
            } else {
              breakthroughMsg.textContent = "Quiz failed! You failed to break through. Try again after cultivating further.";
              eventMsg.textContent = "You feel a bottleneck in your cultivation.";
              if (tribulationActive) {
                player.qi = Math.max(0, Math.floor(player.qi / 2));
                player.talent = Math.max(1, player.talent - 1);
              }
            }
            updateUI();
          }, tribulationActive);
        } else {
          player.miniStageIndex++;
          breakthroughMsg.textContent = `Advanced to ${miniStages[player.miniStageIndex]} Stage of ${mainRealms[player.realmIndex]}`;
          eventMsg.textContent = "Your cultivation base grows.";
          player.qiPerSec += 2 * (player.miniStageIndex+1);
          updateUI();
        }
      }
    };

    // ==== Relationship Actions ====
    function npcAction(npc, action) {
      let msg = "";
      switch(action) {
        case "talk":
          npc.relationship = clamp(npc.relationship+5,0,100);
          msg = `You talked with ${npc.name}. Relationship improved!`;
          npc.history.push("Talked (+5)");
          break;
        case "gift":
          if (player.wealth >= 10) {
            player.wealth -= 10;
            npc.relationship = clamp(npc.relationship+12,0,100);
            msg = `You gave a gift to ${npc.name}. Relationship greatly improved!`;
            npc.history.push("Gifted (+12)");
          } else {
            msg = "Not enough wealth to buy a gift.";
          }
          break;
        case "duel":
          if (Math.random()<0.5) {
            npc.relationship = clamp(npc.relationship-10,0,100);
            msg = `You lost the duel! ${npc.name} looks down on you.`;
            npc.history.push("Lost duel (-10)");
          } else {
            npc.relationship = clamp(npc.relationship+8,0,100);
            msg = `You won the duel! ${npc.name} respects you more.`;
            npc.history.push("Won duel (+8)");
          }
          break;
        case "train":
          npc.relationship = clamp(npc.relationship+3,0,100);
          msg = `You trained with ${npc.name}. Relationship increased.`;
          npc.history.push("Trained (+3)");
          break;
        case "befriend":
          if (npc.relationship>75 && npc.type!=="ally") {
   
