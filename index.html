<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Great Dao</title>
  <style>
    body { font-family:sans-serif; background:#181826; color:#fff; text-align:center; }
    .container { margin:32px auto; padding:24px 32px; background:#282840; border-radius:12px; display:inline-block; }
    .section { margin:18px 0; }
    .stats { font-size:1.1em; margin-bottom:14px; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;}
    .stat { display: flex; align-items: center; gap: 5px; }
    button { margin:6px 10px; padding:8px 20px; background:#7e3ff2; color:#fff; border:none; border-radius:6px; cursor:pointer;}
    button:disabled { background:#444; color:#ccc; cursor:not-allowed;}
    .idle { margin-top:14px; color:#ffd86b; }
    .event { margin-top:12px; font-style:italic; color:#5cf2b2;}
    .breakthrough { margin-top:16px; color:#e6aaff; font-weight:bold;}
    .stage { margin-top:10px; font-size:1.1em; }
    .legacy { margin:18px 0; background:#222; padding:18px; border-radius:8px; }
    .npc-panel { background:#232340; margin:6px 0; padding:8px; border-radius:8px; text-align:left;}
    .npc-rival { color:#f86e6e;}
    .npc-ally { color:#70e3e3;}
    .npc-family { color:#ffd9a0; }
    .npc-love { color:#ff8be2;}
    .npc-mentor { color:#8be2ff; }
    .npc-disciple { color:#b8ff8b; }
    .npc-bar { display:inline-block; width:80px; height:12px; border-radius:6px; margin:0 6px; background:#333; vertical-align:middle;}
    .npc-bar-inner { height:12px; border-radius:6px; }
    #worldEventBanner { margin:24px 0; background:#333; color:#ffd86b; font-size:1.12em; padding:12px; border-radius:8px; display:none; }
    .quest { color:#e3a95f; }
    .descendant { color:#bbffbb; }
    .ancestor { color:#ffd9a0; }
    .infamy { color:#e34b4b; font-weight:bold; }
    .progressbar-wrap { background:#333; border-radius:8px; width:180px; height:16px; display:inline-block; vertical-align:middle; margin-left:8px; }
    .progressbar-inner { background:linear-gradient(90deg,#7e3ff2,#ffd86b); height:16px; border-radius:8px; transition: width 0.6s; }
    .progressbar-label { position:absolute; width:180px; color:#fff; font-size:0.88em; left:0; top:-1px; text-align:center; pointer-events:none;}
    .action-bar { display: flex; flex-wrap: wrap; gap: 8px; justify-content:center; margin-bottom:12px;}
    .action-btn { display: flex; align-items: center; gap: 7px; background:#7e3ff2; border:none; color:#fff; padding:7px 16px; border-radius:7px; cursor:pointer; font-size:1em;}
    .action-btn:disabled { background:#444; color:#ccc; cursor:not-allowed;}
    #worldTab { background:#222; border-radius:10px; margin:20px auto 0 auto; padding:14px 22px; max-width:640px; text-align:left; }
    #worldTab h2 { color: #ffd86b; }
    .location-block { background: #232340; border-radius:8px; padding:10px; margin:8px 0;}
    .location-title { color:#70e3e3; font-weight:bold; }
    .location-npcs { margin-left: 14px; }
    .kingdom-info { margin:10px 0; padding:10px; background:#282840; border-radius:8px;}
    #kingdomModal { display:none; position:fixed; top:0;left:0;width:100vw;height:100vh; background:rgba(0,0,0,0.85); z-index:999; }
    #kingdomModalContent { background:#222; padding:24px; margin:80px auto; max-width:400px; border-radius:12px; box-shadow:0 2px 16px #8e44ad; color: #fff; text-align:left;}
    #kingdomModalContent label { font-weight:bold; }
    #kingdomModalContent input { width: 100%; padding: 8px; margin: 10px 0; border-radius: 6px; border: 1px solid #444; }
    #kingdomModalContent button { background:#7e3ff2; color:#fff; margin-top:10px;}
    #worldNewsBtn { background:#ffd86b; color:#282840; margin-left:12px; }
    #worldNewsPanel { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(20,20,40,0.97); z-index:2000; display:none; }
    #worldNewsContent { background:#222; padding:28px; margin:60px auto; max-width:520px; border-radius:16px; box-shadow:0 2px 16px #ffd86b; color: #fff; text-align:left; min-height:300px;}
    #closeWorldNewsBtn { float:right; margin-bottom:18px; background:#ffd86b; color:#282840; }
    .news-feed { margin:0 0 20px 0; padding:0; list-style:none; }
    .news-item { margin-bottom:14px; padding:9px 12px; background:#232340; border-radius:7px; font-size:1.02em;}
    .news-timestamp { color:#ffd86b; font-size:0.88em; margin-right:8px;}
    .news-important { color:#e34b4b; font-weight:bold;}
    .merged-actions-btn { background:#ffd86b; color:#282840; border-radius:7px; padding:5px 13px; margin:4px 0; font-weight:bold; }
    .actions-menu { background:#333; color:#fff; border-radius:8px; padding:12px; position:absolute; z-index:99; box-shadow:0 2px 10px #ffd86b; min-width:160px;}
    .actions-menu button { display:block; width:100%; margin:4px 0; background:#7e3ff2; color:#fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Great Dao</h1>
    <div id="saveLoadBar">
      <button id="saveBtn">Save Game</button>
      <button id="loadBtn">Load Game</button>
      <span id="saveStatus"></span>
    </div>
    <div class="section stats">
      <div class="stat" title="Age">
        Age: <span id="ageDisplay"></span>
        <div class="progressbar-wrap" style="position:relative;">
          <div id="ageBar" class="progressbar-inner"></div>
          <span id="ageBarLabel" class="progressbar-label"></span>
        </div>
      </div>
      <div class="stat" title="Health">
        Health: <span id="healthDisplay"></span>
        <div class="progressbar-wrap" style="position:relative;">
          <div id="healthBar" class="progressbar-inner" style="background:linear-gradient(90deg,#f86e6e,#ffd86b);"></div>
          <span id="healthBarLabel" class="progressbar-label"></span>
        </div>
      </div>
      <div class="stat" title="Talent">
        Talent: <span id="talentDisplay"></span>
      </div>
      <div class="stat" title="Wealth">
        Wealth: <span id="wealthDisplay"></span>
      </div>
      <div class="stat" title="Relationships">
        Relationships: <span id="relDisplay"></span>
        <div class="progressbar-wrap" style="position:relative;">
          <div id="relBar" class="progressbar-inner" style="background:linear-gradient(90deg,#ffd9a0,#7e3ff2);"></div>
          <span id="relBarLabel" class="progressbar-label"></span>
        </div>
      </div>
      <div class="stat" title="Qi">
        Qi: <span id="qiDisplay"></span>
        <div class="progressbar-wrap" style="position:relative;">
          <div id="qiBar" class="progressbar-inner" style="background:linear-gradient(90deg,#7e3ff2,#ffd86b);"></div>
          <span id="qiBarLabel" class="progressbar-label"></span>
        </div>
      </div>
      <div class="stat" title="Qi/sec">
        Qi/sec: <span id="qpsDisplay"></span>
      </div>
      <div class="stat" title="Infamy">
        <span class="infamy">Infamy: <span id="infamyDisplay"></span></span>
      </div>
      <button id="worldNewsBtn">World News</button>
    </div>
    <div class="section action-bar">
      <button id="studyBtn" class="action-btn" title="Study">Study</button>
      <button id="trainBtn" class="action-btn" title="Train">Train</button>
      <button id="workBtn" class="action-btn" title="Work">Work</button>
      <button id="restBtn" class="action-btn" title="Rest">Rest</button>
      <button id="meetBtn" class="action-btn" title="Meet NPC">Meet NPC</button>
      <button id="cultivateBtn" class="action-btn" title="Meditate">Meditate</button>
      <button id="advanceBtn" class="action-btn" title="Advance">Advance</button>
      <button id="relationshipBtn" class="action-btn" title="Relationships">Relationships</button>
      <button id="worldBtn" class="action-btn" title="World">World</button>
    </div>
    <div class="section idle">
      <div class="stage">
        Realm: <span id="realmDisplay"></span>
        <br>
        Stage: <span id="miniStageDisplay"></span>
      </div>
    </div>
    <div class="breakthrough" id="breakthroughMsg"></div>
    <div class="event" id="eventMsg"></div>
    <div id="worldEventBanner"></div>
    <div class="legacy" id="legacyPanel">
      <strong class="ancestor">Lineage Legacy:</strong>
      <div id="familyTree"></div>
      <div id="inheritedQuests"></div>
    </div>
    <div id="kingdomInfoPanel"></div>
  </div>
  <!-- WORLD Tab Modal -->
  <div id="worldTab" style="display:none;">
    <h2>World</h2>
    <div id="locationList"></div>
    <button id="closeWorldTab" style="margin-top:14px;background:#7e3ff2;color:#fff;border:none;padding:8px 18px;border-radius:7px;">Close</button>
  </div>
  <!-- World News Modal -->
  <div id="worldNewsPanel">
    <div id="worldNewsContent">
      <button id="closeWorldNewsBtn">Close</button>
      <h2>World News</h2>
      <ul id="newsFeed" class="news-feed"></ul>
    </div>
  </div>
  <!-- Kingdom Naming Modal -->
  <div id="kingdomModal">
    <div id="kingdomModalContent">
      <label>Congratulations! You've conquered a kingdom.<br>Choose a name for your new kingdom:</label>
      <input type="text" id="kingdomNameInput" maxlength="24" placeholder="Enter kingdom name...">
      <button id="confirmKingdomNameBtn">Confirm</button>
      <div id="kingdomModalMsg"></div>
    </div>
  </div>
  <!-- NPC Relationship Panel Modal -->
  <div id="npcPanel">
    <div id="npcPanelContent">
      <button id="closeNpcPanel">Close</button>
      <h2>Your Relationships</h2>
      <div id="knownNpcList"></div>
    </div>
  </div>
  <script>
    // ==== World News Feed ====
    let worldNews = [];
    function addWorldNews(msg, important=false) {
      const now = new Date();
      const ts = now.toLocaleDateString() + " " + now.toLocaleTimeString();
      worldNews.unshift({msg, ts, important});
      if (worldNews.length > 20) worldNews.pop();
      renderWorldNews();
    }
    function renderWorldNews() {
      const newsFeed = document.getElementById('newsFeed');
      newsFeed.innerHTML = worldNews.length === 0 ? "<li>No news yet.</li>" :
        worldNews.map(item =>
          `<li class="news-item${item.important ? ' news-important' : ''}">
            <span class="news-timestamp">${item.ts}</span> ${item.msg}
          </li>`
        ).join("");
    }
    document.getElementById('worldNewsBtn').onclick = function() {
      renderWorldNews();
      document.getElementById('worldNewsPanel').style.display = "block";
    };
    document.getElementById('closeWorldNewsBtn').onclick = function() {
      document.getElementById('worldNewsPanel').style.display = "none";
    };

    // ==== World, NPC, Kingdom Definitions ====
    const worldLocations = [
      {name:"Heavenly Sect", type:"Sect"},
      {name:"Mystic Mountain", type:"Mountain"},
      {name:"Imperial City", type:"City"},
      {name:"Spirit Forest", type:"Forest"},
      {name:"Azure Lake", type:"Lake"},
      {name:"Red Temple", type:"Temple"},
      {name:"Jade Kingdom", type:"Kingdom", resources:{wealth:200, qi:300, troops:50}, ruler:null},
      {name:"Iron Kingdom", type:"Kingdom", resources:{wealth:150, qi:180, troops:40}, ruler:null},
      {name:"Dragon Kingdom", type:"Kingdom", resources:{wealth:320, qi:400, troops:110}, ruler:null}
    ];
    let npcFamilies = ["Zhou", "Mei", "Chen", "Li", "Xiao", "Wang", "Yu", "Tian", "Luo", "Fang", "Qin", "Hua", "Lan", "Jin", "Rong", "Bo", "Wei", "Shen", "Min", "Yan"];
    function randomFrom(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
    function clamp(val,min,max) { return Math.max(min,Math.min(max,val)); }
    let npcTypes = [
      {type:"rival", label:"Rival", color:"npc-rival"},
      {type:"ally", label:"Ally", color:"npc-ally"},
      {type:"family", label:"Family", color:"npc-family"},
      {type:"love", label:"Love Interest", color:"npc-love"},
      {type:"mentor", label:"Mentor", color:"npc-mentor"},
      {type:"disciple", label:"Disciple", color:"npc-disciple"}
    ];
    let npcTraits = ["Loyal", "Ambitious", "Hot-headed", "Wise", "Jealous", "Generous", "Secretive", "Bold", "Kind", "Scheming", "Righteous", "Detached"];
    let npcPool = [];
    let knownNPCs = [];
    function createNPC(index) {
      let typeObj = randomFrom(npcTypes);
      let family = randomFrom(npcFamilies) + " Family";
      let locationObj = randomFrom(worldLocations);
      let affiliation = locationObj.type === "Kingdom" ? locationObj.name : family;
      return {
        id: "npc-"+index+"-"+family+"-"+Math.floor(Math.random()*10000),
        name: randomFrom(npcFamilies)+" "+(Math.random()<0.4 ? randomFrom(npcFamilies) : ""),
        type: typeObj.type,
        label: typeObj.label,
        color: typeObj.color,
        trait: randomFrom(npcTraits),
        family: family,
        affiliation: affiliation,
        relationship: clamp(Math.floor(Math.random()*60)+20,0,100),
        talent: clamp(Math.floor(Math.random()*4)+1,1,6),
        age: Math.floor(Math.random()*30)+14,
        qi: Math.floor(Math.random()*150),
        qiPerSec: 1,
        realmIndex: Math.floor(Math.random()*3),
        miniStageIndex: Math.floor(Math.random()*2),
        alive: true,
        married: false,
        spouseId: null,
        history: [],
        location: locationObj.name
      };
    }
    function generateNPCPool(n=15) {
      npcPool = [];
      knownNPCs = [];
      for (let i=0;i<n;i++) npcPool.push(createNPC(i));
    }
    generateNPCPool();

    // ==== Player State ====
    let player = {
      name: "You",
      age: 16,
      health: 100,
      talent: 2,
      relationships: 0,
      wealth: 50,
      qi: 0,
      qiPerSec: 1,
      realmIndex: 0,
      miniStageIndex: 0,
      quests: [],
      alive: true,
      infamy: 0,
      kingdom: null
    };

    // ==== UI Elements ====
    const ageDisplay = document.getElementById('ageDisplay');
    const healthDisplay = document.getElementById('healthDisplay');
    const talentDisplay = document.getElementById('talentDisplay');
    const relDisplay = document.getElementById('relDisplay');
    const wealthDisplay = document.getElementById('wealthDisplay');
    const qiDisplay = document.getElementById('qiDisplay');
    const qpsDisplay = document.getElementById('qpsDisplay');
    const infamyDisplay = document.getElementById('infamyDisplay');
    const realmDisplay = document.getElementById('realmDisplay');
    const miniStageDisplay = document.getElementById('miniStageDisplay');
    const advanceBtn = document.getElementById('advanceBtn');
    const eventMsg = document.getElementById('eventMsg');
    const breakthroughMsg = document.getElementById('breakthroughMsg');
    const worldEventBanner = document.getElementById('worldEventBanner');
    const familyTreeDiv = document.getElementById('familyTree');
    const inheritedQuestsDiv = document.getElementById('inheritedQuests');
    const npcPanel = document.getElementById('npcPanel');
    const knownNpcListDiv = document.getElementById('knownNpcList');
    const relationshipBtn = document.getElementById('relationshipBtn');
    const closeNpcPanelBtn = document.getElementById('closeNpcPanel');
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const saveStatus = document.getElementById('saveStatus');
    const ageBar = document.getElementById('ageBar');
    const ageBarLabel = document.getElementById('ageBarLabel');
    const healthBar = document.getElementById('healthBar');
    const healthBarLabel = document.getElementById('healthBarLabel');
    const relBar = document.getElementById('relBar');
    const relBarLabel = document.getElementById('relBarLabel');
    const qiBar = document.getElementById('qiBar');
    const qiBarLabel = document.getElementById('qiBarLabel');
    const worldBtn = document.getElementById('worldBtn');
    const worldTab = document.getElementById('worldTab');
    const locationList = document.getElementById('locationList');
    const closeWorldTabBtn = document.getElementById('closeWorldTab');
    const kingdomInfoPanel = document.getElementById('kingdomInfoPanel');
    // Kingdom Naming Modal
    const kingdomModal = document.getElementById('kingdomModal');
    const kingdomNameInput = document.getElementById('kingdomNameInput');
    const confirmKingdomNameBtn = document.getElementById('confirmKingdomNameBtn');
    const kingdomModalMsg = document.getElementById('kingdomModalMsg');

    // ==== Save & Load System ====
    function saveGame() {
      const gameState = {
        player,
        npcPool,
        knownNPCs,
        worldNews
      };
      localStorage.setItem('greatdao_save', JSON.stringify(gameState));
      saveStatus.textContent = "Game Saved!";
      setTimeout(()=>saveStatus.textContent="",2000);
    }
    function loadGame() {
      const data = localStorage.getItem('greatdao_save');
      if (data) {
        try {
          const state = JSON.parse(data);
          player = state.player;
          npcPool = state.npcPool;
          knownNPCs = state.knownNPCs;
          worldNews = state.worldNews || [];
          saveStatus.textContent = "Game Loaded!";
          updateUI();
          setTimeout(()=>saveStatus.textContent="",2000);
        } catch(e) {
          saveStatus.textContent = "Load Failed!";
        }
      } else {
        saveStatus.textContent = "No Save Found!";
      }
    }
    window.onload = function() {
      if (localStorage.getItem('greatdao_save')) {
        loadGame();
      }
    };
    saveBtn.onclick = saveGame;
    loadBtn.onclick = loadGame;

    // ==== World Tab logic with merged actions ====
    worldBtn.onclick = function() {
      renderWorldTab();
      worldTab.style.display = "block";
    };
    closeWorldTabBtn.onclick = function() {
      worldTab.style.display = "none";
      closeActionsMenu();
    };

    function renderWorldTab() {
      let locMap = {};
      worldLocations.forEach(loc => locMap[loc.name] = []);
      knownNPCs.forEach(npc => {
        if (!locMap[npc.location]) locMap[npc.location] = [];
        locMap[npc.location].push(npc);
      });
      locationList.innerHTML = Object.keys(locMap).map(locName => {
        let loc = worldLocations.find(l=>l.name===locName);
        let npcsHere = locMap[locName] || [];
        let isKingdom = loc?.type === "Kingdom";
        let isControlled = player.kingdom && player.kingdom.location === locName;
        let controlBtn = !isControlled && isKingdom && !loc.ruler ?
          `<button onclick="window.claimKingdom('${locName}')">Conquer & Control</button>` : "";
        let kingdomInfo = isKingdom ?
          `<div class="kingdom-info">
            Wealth: ${loc.resources.wealth} | Qi: ${loc.resources.qi} | Troops: ${loc.resources.troops} 
            | Ruler: ${loc.ruler || "None"}
            ${controlBtn}
          </div>` : "";
        // Merged actions button for location/party/kingdom
        let mergedActionsBtn = `<button class="merged-actions-btn" onclick="window.openActionsMenu('${locName}', event)">Actions</button>`;
        return `
          <div class="location-block">
            <div class="location-title">${loc?.name || locName} <small>(${loc?.type || ""})</small></div>
            ${kingdomInfo}
            <div class="location-npcs">
              ${npcsHere.length ? npcsHere.map(npc =>
                `<span class="${npc.color}">${npc.name} (${npc.label}, Talent:${npc.talent})
                  <button class="merged-actions-btn" onclick="window.openActionsMenuForNPC('${npc.id}', event)">Actions</button>
                </span>`
              ).join(", ") : "<em>No known NPCs here.</em>"}
            </div>
            ${mergedActionsBtn}
          </div>
        `;
      }).join("");
    }

    // ==== Merged Actions Menus ====
    let actionsMenuDiv = null;
    window.openActionsMenu = function(locName, ev) {
      closeActionsMenu();
      actionsMenuDiv = document.createElement('div');
      actionsMenuDiv.className = "actions-menu";
      actionsMenuDiv.style.top = ev.clientY + "px";
