<script>
    // ==== World News Feed ====
    let worldNews = [];
    function addWorldNews(msg, important=false) {
      const now = new Date();
      const ts = now.toLocaleDateString() + " " + now.toLocaleTimeString();
      worldNews.unshift({msg, ts, important});
      if (worldNews.length > 20) worldNews.pop();
      renderWorldNews();
    }
    function renderWorldNews() {
      const newsFeed = document.getElementById('newsFeed');
      newsFeed.innerHTML = worldNews.length === 0 ? "<li>No news yet.</li>" :
        worldNews.map(item =>
          `<li class="news-item${item.important ? ' news-important' : ''}">
            <span class="news-timestamp">${item.ts}</span> ${item.msg}
          </li>`
        ).join("");
    }
    document.getElementById('worldNewsBtn').onclick = function() {
      renderWorldNews();
      document.getElementById('worldNewsPanel').style.display = "block";
    };
    document.getElementById('closeWorldNewsBtn').onclick = function() {
      document.getElementById('worldNewsPanel').style.display = "none";
    };

    // ==== World, NPC, Kingdom Definitions ====
    const worldLocations = [
      {name:"Heavenly Sect", type:"Sect"},
      {name:"Mystic Mountain", type:"Mountain"},
      {name:"Imperial City", type:"City"},
      {name:"Spirit Forest", type:"Forest"},
      {name:"Azure Lake", type:"Lake"},
      {name:"Red Temple", type:"Temple"},
      {name:"Jade Kingdom", type:"Kingdom", resources:{wealth:200, qi:300, troops:50}, ruler:null},
      {name:"Iron Kingdom", type:"Kingdom", resources:{wealth:150, qi:180, troops:40}, ruler:null},
      {name:"Dragon Kingdom", type:"Kingdom", resources:{wealth:320, qi:400, troops:110}, ruler:null}
    ];
    let npcFamilies = ["Zhou", "Mei", "Chen", "Li", "Xiao", "Wang", "Yu", "Tian", "Luo", "Fang", "Qin", "Hua", "Lan", "Jin", "Rong", "Bo", "Wei", "Shen", "Min", "Yan"];
    let bossNames = [
      {name:"Demon Lord", trait:"Tyrannical", type:"boss", color:"npc-boss"},
      {name:"Evil Patriarch", trait:"Cunning", type:"boss", color:"npc-boss"},
      {name:"Rogue Immortal", trait:"Unpredictable", type:"boss", color:"npc-boss"},
      {name:"Heavenly Calamity", trait:"Destructive", type:"boss", color:"npc-boss"}
    ];
    function randomFrom(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
    function clamp(val,min,max) { return Math.max(min,Math.min(max,val)); }
    let npcTypes = [
      {type:"rival", label:"Rival", color:"npc-rival"},
      {type:"ally", label:"Ally", color:"npc-ally"},
      {type:"family", label:"Family", color:"npc-family"},
      {type:"love", label:"Love Interest", color:"npc-love"},
      {type:"mentor", label:"Mentor", color:"npc-mentor"},
      {type:"disciple", label:"Disciple", color:"npc-disciple"},
      {type:"enemy", label:"Enemy", color:"npc-enemy"}
    ];
    let npcTraits = ["Loyal", "Ambitious", "Hot-headed", "Wise", "Jealous", "Generous", "Secretive", "Bold", "Kind", "Scheming", "Righteous", "Detached"];
    let npcPool = [];
    let knownNPCs = [];
    function createNPC(index) {
      // Bosses (first few NPC slots)
      if (index < bossNames.length) {
        let boss = bossNames[index];
        let locationObj = randomFrom(worldLocations.filter(l=>l.type==="Kingdom"||l.type==="Sect"));
        return {
          id: "boss-"+boss.name.replace(" ","")+"-"+Math.floor(Math.random()*10000),
          name: boss.name,
          type: "boss",
          label: "Boss Enemy",
          color: boss.color,
          trait: boss.trait,
          family: boss.name + " Faction",
          affiliation: boss.name + " Faction",
          relationship: Math.floor(Math.random()*40),
          talent: 7 + index,
          age: 200 + index*50,
          qi: 400 + index*100,
          qiPerSec: 8 + index*2,
          realmIndex: Math.min(22, 12+index*2),
          miniStageIndex: 3,
          alive: true,
          married: false,
          spouseId: null,
          history: [],
          location: locationObj.name
        };
      }
      // Random enemies (some will be "enemy" type)
      let typeObj = Math.random()<0.2 ? {type:"enemy", label:"Enemy", color:"npc-enemy"} : randomFrom(npcTypes);
      let family = randomFrom(npcFamilies) + " Family";
      let locationObj = randomFrom(worldLocations);
      let affiliation = locationObj.type === "Kingdom" ? locationObj.name : family;
      return {
        id: "npc-"+index+"-"+family+"-"+Math.floor(Math.random()*10000),
        name: randomFrom(npcFamilies)+" "+(Math.random()<0.4 ? randomFrom(npcFamilies) : ""),
        type: typeObj.type,
        label: typeObj.label,
        color: typeObj.color,
        trait: randomFrom(npcTraits),
        family: family,
        affiliation: affiliation,
        relationship: clamp(Math.floor(Math.random()*60)+20,0,100),
        talent: clamp(Math.floor(Math.random()*4)+1,1,6),
        age: Math.floor(Math.random()*30)+14,
        qi: Math.floor(Math.random()*150),
        qiPerSec: 1,
        realmIndex: Math.floor(Math.random()*3),
        miniStageIndex: Math.floor(Math.random()*2),
        alive: true,
        married: false,
        spouseId: null,
        history: [],
        location: locationObj.name
      };
    }
    function generateNPCPool(n=18) {
      npcPool = [];
      knownNPCs = [];
      for (let i=0;i<n;i++) npcPool.push(createNPC(i));
    }
    generateNPCPool();

    // ==== Player State ====
    let player = {
      name: "You",
      age: 16,
      health: 100,
      talent: 2,
      relationships: 0,
      wealth: 50,
      spiritStones: 15,
      qi: 0,
      qiPerSec: 1,
      realmIndex: 0,
      miniStageIndex: 0,
      quests: [],
      alive: true,
      infamy: 0,
      kingdom: null
    };

    // ==== UI Elements ====
    const ageDisplay = document.getElementById('ageDisplay');
    const healthDisplay = document.getElementById('healthDisplay');
    const talentDisplay = document.getElementById('talentDisplay');
    const relDisplay = document.getElementById('relDisplay');
    const wealthDisplay = document.getElementById('wealthDisplay');
    const spiritStoneDisplay = document.getElementById('spiritStoneDisplay');
    const qiDisplay = document.getElementById('qiDisplay');
    const qpsDisplay = document.getElementById('qpsDisplay');
    const infamyDisplay = document.getElementById('infamyDisplay');
    const realmDisplay = document.getElementById('realmDisplay');
    const miniStageDisplay = document.getElementById('miniStageDisplay');
    const advanceBtn = document.getElementById('advanceBtn');
    const eventMsg = document.getElementById('eventMsg');
    const breakthroughMsg = document.getElementById('breakthroughMsg');
    const worldEventBanner = document.getElementById('worldEventBanner');
    const familyTreeDiv = document.getElementById('familyTree');
    const inheritedQuestsDiv = document.getElementById('inheritedQuests');
    const npcPanel = document.getElementById('npcPanel');
    const knownNpcListDiv = document.getElementById('knownNpcList');
    const relationshipBtn = document.getElementById('relationshipBtn');
    const closeNpcPanelBtn = document.getElementById('closeNpcPanel');
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const saveStatus = document.getElementById('saveStatus');
    const ageBar = document.getElementById('ageBar');
    const ageBarLabel = document.getElementById('ageBarLabel');
    const healthBar = document.getElementById('healthBar');
    const healthBarLabel = document.getElementById('healthBarLabel');
    const relBar = document.getElementById('relBar');
    const relBarLabel = document.getElementById('relBarLabel');
    const qiBar = document.getElementById('qiBar');
    const qiBarLabel = document.getElementById('qiBarLabel');
    const worldBtn = document.getElementById('worldBtn');
    const worldTab = document.getElementById('worldTab');
    const locationList = document.getElementById('locationList');
    const closeWorldTabBtn = document.getElementById('closeWorldTab');
    const kingdomInfoPanel = document.getElementById('kingdomInfoPanel');
    // Kingdom Naming Modal
    const kingdomModal = document.getElementById('kingdomModal');
    const kingdomNameInput = document.getElementById('kingdomNameInput');
    const confirmKingdomNameBtn = document.getElementById('confirmKingdomNameBtn');
    const kingdomModalMsg = document.getElementById('kingdomModalMsg');

    // ==== Save & Load System ====
    function saveGame() {
      const gameState = {
        player,
        npcPool,
        knownNPCs,
        worldNews
      };
      localStorage.setItem('greatdao_save', JSON.stringify(gameState));
      saveStatus.textContent = "Game Saved!";
      setTimeout(()=>saveStatus.textContent="",2000);
    }
    function loadGame() {
      const data = localStorage.getItem('greatdao_save');
      if (data) {
        try {
          const state = JSON.parse(data);
          player = state.player;
          npcPool = state.npcPool;
          knownNPCs = state.knownNPCs;
          worldNews = state.worldNews || [];
          saveStatus.textContent = "Game Loaded!";
          updateUI();
          setTimeout(()=>saveStatus.textContent="",2000);
        } catch(e) {
          saveStatus.textContent = "Load Failed!";
        }
      } else {
        saveStatus.textContent = "No Save Found!";
      }
    }
    window.onload = function() {
      if (localStorage.getItem('greatdao_save')) {
        loadGame();
      }
    };
    saveBtn.onclick = saveGame;
    loadBtn.onclick = loadGame;

    // ==== World Tab logic with merged actions ====
    worldBtn.onclick = function() {
      renderWorldTab();
      worldTab.style.display = "block";
    };
    closeWorldTabBtn.onclick = function() {
      worldTab.style.display = "none";
      closeActionsMenu();
    };

    function renderWorldTab() {
      let locMap = {};
      worldLocations.forEach(loc => locMap[loc.name] = []);
      knownNPCs.forEach(npc => {
        if (!locMap[npc.location]) locMap[npc.location] = [];
        locMap[npc.location].push(npc);
      });
      locationList.innerHTML = Object.keys(locMap).map(locName => {
        let loc = worldLocations.find(l=>l.name===locName);
        let npcsHere = locMap[locName] || [];
        let isKingdom = loc?.type === "Kingdom";
        let isControlled = player.kingdom && player.kingdom.location === locName;
        let controlBtn = !isControlled && isKingdom && !loc.ruler ?
          `<button onclick="window.claimKingdom('${locName}')">Conquer & Control</button>` : "";
        let kingdomInfo = isKingdom ?
          `<div class="kingdom-info">
            Wealth: ${loc.resources.wealth} | Qi: ${loc.resources.qi} | Troops: ${loc.resources.troops} 
            | Ruler: ${loc.ruler || "None"}
            ${controlBtn}
          </div>` : "";
        let mergedActionsBtn = `<button class="merged-actions-btn" onclick="window.openActionsMenu('${locName}', event)">Actions</button>`;
        return `
          <div class="location-block">
            <div class="location-title">${loc?.name || locName} <small>(${loc?.type || ""})</small></div>
            ${kingdomInfo}
            <div class="location-npcs">
              ${npcsHere.length ? npcsHere.map(npc =>
                `<span class="${npc.color}">${npc.name} (${npc.label}, Talent:${npc.talent})
                  <button class="merged-actions-btn" onclick="window.openActionsMenuForNPC('${npc.id}', event)">Actions</button>
                </span>`
              ).join(", ") : "<em>No known NPCs here.</em>"}
            </div>
            ${mergedActionsBtn}
          </div>
        `;
      }).join("");
    }

    // ==== Merged Actions Menus ====
    let actionsMenuDiv = null;
    window.openActionsMenu = function(locName, ev) {
      closeActionsMenu();
      actionsMenuDiv = document.createElement('div');
      actionsMenuDiv.className = "actions-menu";
      actionsMenuDiv.style.top = ev.clientY + "px";
      actionsMenuDiv.style.left = ev.clientX + "px";
      let loc = worldLocations.find(l=>l.name===locName);
      let isKingdom = loc?.type === "Kingdom";
      let btns = [
        `<button onclick="window.offendParty('${locName}');closeActionsMenu();">Offend</button>`,
        isKingdom ?
          `<button onclick="window.wipeKingdom('${locName}');closeActionsMenu();">Wipe Out Kingdom</button>` :
          `<button onclick="window.wipeFamily('${locName}');closeActionsMenu();">Wipe Out Family</button>`,
        isKingdom && !loc.ruler ? `<button onclick="window.claimKingdom('${locName}');closeActionsMenu();">Conquer & Control</button>` : ""
      ];
      actionsMenuDiv.innerHTML = btns.join("");
      document.body.appendChild(actionsMenuDiv);
      ev.stopPropagation();
    };
    window.openActionsMenuForNPC = function(npcId, ev) {
      closeActionsMenu();
      actionsMenuDiv = document.createElement('div');
      actionsMenuDiv.className = "actions-menu";
      actionsMenuDiv.style.top = ev.clientY + "px";
      actionsMenuDiv.style.left = ev.clientX + "px";
      actionsMenuDiv.innerHTML = `<button onclick="window.killNPC('${npcId}');closeActionsMenu();">Kill</button>`;
      document.body.appendChild(actionsMenuDiv);
      ev.stopPropagation();
    };
    function closeActionsMenu() {
      if (actionsMenuDiv && actionsMenuDiv.parentNode) actionsMenuDiv.parentNode.removeChild(actionsMenuDiv);
      actionsMenuDiv = null;
    }
    window.closeActionsMenu = closeActionsMenu;
    document.body.onclick = closeActionsMenu;

    // ==== WORLD ACTIONS ====
    window.offendParty = function(locName) {
      let loc = worldLocations.find(l=>l.name===locName);
      knownNPCs.forEach(npc => {
        if (npc.location === locName) {
          npc.type = "rival";
          npc.label = "Rival";
          npc.color = "npc-rival";
          npc.relationship = clamp(npc.relationship-40,0,100);
          npc.history.push("You offended their party!");
        }
      });
      player.infamy += 10;
      eventMsg.textContent = `You have offended the entire party at ${locName}. They are now your rivals. Infamy increased!`;
      addWorldNews(`Player offended all at ${locName}. Now rivals.`, true);
      updateUI();
    };

    window.killNPC = function(npcId) {
      let npc = knownNPCs.find(n=>n.id===npcId);
      if (npc) {
        let realmDiff = player.realmIndex - npc.realmIndex;
        if (realmDiff >= 2) {
          npc.alive = false;
          npc.history.push("Killed by player");
          player.infamy += 15;
          eventMsg.textContent = `You killed ${npc.name}. Infamy increased!`;
          addWorldNews(`Player killed ${npc.name} at ${npc.location}.`, true);
          // Bosses drop spirit stones
          if (npc.type === "boss") {
            let stones = 50 + Math.floor(Math.random()*50);
            player.spiritStones += stones;
            addWorldNews(`Player defeated boss ${npc.name} and looted ${stones} Spirit Stones!`, true);
          }
        } else {
          eventMsg.textContent = `You are not strong enough to kill ${npc.name}.`;
        }
        updateUI();
      }
    };

    window.wipeFamily = function(locName) {
      let affected = knownNPCs.filter(npc => npc.affiliation === locName || npc.family === locName);
      if (affected.length === 0) {
        eventMsg.textContent = "No family found to wipe out here.";
        return;
      }
      let canWipe = player.realmIndex >= 8;
      if (canWipe) {
        affected.forEach(npc => { npc.alive = false; npc.history.push("Family wiped out by player"); });
        player.infamy += 40;
        eventMsg.textContent = `You have wiped out the ${locName}. Infamy greatly increased!`;
        addWorldNews(`Player wiped out the ${locName}.`, true);
      } else {
        eventMsg.textContent = "You must reach at least the 8th realm to wipe out a family.";
      }
      updateUI();
    };

    window.wipeKingdom = function(locName) {
      let loc = worldLocations.find(l=>l.name===locName);
      if (!loc || loc.type !== "Kingdom") {
        eventMsg.textContent = "Not a kingdom.";
        return;
      }
      let canWipe = player.realmIndex >= 12;
      if (canWipe) {
        knownNPCs.forEach(npc => { if (npc.location === locName) npc.alive = false; });
        loc.ruler = null;
        player.infamy += 100;
        eventMsg.textContent = `You have wiped out the kingdom of ${locName}. World will remember this atrocity. Infamy massively increased!`;
        addWorldNews(`Player wiped out the kingdom of ${locName}! Atrocity shakes the world!`, true);
      } else {
        eventMsg.textContent = "You must reach at least the 12th realm to wipe out a kingdom.";
      }
      updateUI();
    };

    window.claimKingdom = function(locName) {
      let loc = worldLocations.find(l=>l.name===locName);
      if (!loc || loc.type !== "Kingdom" || loc.ruler) {
        eventMsg.textContent = "Cannot claim this kingdom.";
        return;
      }
      let rivals = knownNPCs.filter(npc => npc.location === locName && npc.type === "rival" && npc.alive);
      let canClaim = player.realmIndex >= 7 && rivals.length === 0;
      if (canClaim) {
        showKingdomNamingModal(loc);
      } else if (player.realmIndex < 7) {
        eventMsg.textContent = "You must reach at least the 7th realm to conquer a kingdom.";
      } else {
        eventMsg.textContent = "You must defeat all rivals in this kingdom before conquering.";
      }
      updateUI();
    };

    function showKingdomNamingModal(locationObj) {
      kingdomModal.style.display = 'block';
      kingdomModalMsg.textContent = '';
      confirmKingdomNameBtn.onclick = function() {
        let name = kingdomNameInput.value.trim();
        if (!name || name.length < 2) {
          kingdomModalMsg.textContent = "Name must be at least 2 characters.";
          return;
        }
        player.kingdom = {
          name: name,
          location: locationObj.name,
          resources: {...locationObj.resources},
          troops: locationObj.resources?.troops || 40
        };
        locationObj.ruler = player.name;
        kingdomModal.style.display = 'none';
        eventMsg.textContent = `You have claimed the kingdom "${name}"! Manage its resources wisely.`;
        addWorldNews(`Player has claimed and named the kingdom "${name}" at ${locationObj.name}!`, true);
        updateUI();
      };
    }
    kingdomModal.onclick = function(e){if(e.target===kingdomModal)kingdomModal.style.display='none';};

    // ==== KINGDOM RESOURCE GENERATION ====
    setInterval(function() {
      if (player.kingdom) {
        player.kingdom.resources.wealth += 3 + Math.floor(player.kingdom.troops/10);
        player.kingdom.resources.qi += 6 + Math.floor(player.talent/2);
        player.kingdom.troops += Math.random()<0.05 ? 1 : 0;
        // Spirit Stones income for owning a kingdom
        player.spiritStones += 2 + Math.floor(player.kingdom.troops/20);
        if (Math.random()<0.22) {
          addWorldNews(`Kingdom "${player.kingdom.name}" gains resources: Wealth ${player.kingdom.resources.wealth}, Qi ${player.kingdom.resources.qi}, Troops ${player.kingdom.troops}, Spirit Stones ${player.spiritStones}.`);
        }
        updateUI();
      }
    }, 4000);

    // ==== Life/Idle/Stats & Cultivation ====
    setInterval(function() {
      if (player.health > 0 && player.alive) {
        player.qi += player.qiPerSec;
      }
      updateUI();
      let nextQiNeeded = qiNeeded[player.realmIndex]?.[player.miniStageIndex] || 0;
      advanceBtn.disabled = !(player.qi >= nextQiNeeded);
    }, 1000);

    setInterval(function() {
      if (!player.alive) return;
      player.age++; player.health = Math.max(player.health - 2, 0);
      if (player.health <= 0) {
        eventMsg.textContent = "You died! Your legacy passes to your descendant.";
        breakthroughMsg.textContent = "";
        addWorldNews("Player died. Descendant inherits legacy.", true);
        player = {
          name: "Descendant",
          age: 16,
          health: 100,
          talent: Math.max(2, Math.floor(player.talent * (0.7 + Math.random()*0.3))),
          relationships: Math.max(0, Math.floor(player.relationships * 0.5)),
          wealth: 50,
          spiritStones: Math.max(10, Math.floor(player.spiritStones * 0.5)),
          qi: Math.max(0, Math.floor(player.qi * 0.3)),
          qiPerSec: 1 + Math.max(2, Math.floor(player.talent * (0.7 + Math.random()*0.3))),
          realmIndex: Math.max(0, player.realmIndex - 1),
          miniStageIndex: 0,
          quests: [],
          alive: true,
          infamy: Math.floor(player.infamy * 0.7),
          kingdom: null
        };
        generateNPCPool();
        updateUI();
      }
    }, 12000);

    // ==== Cultivation Stages ====
    const mainRealms = [
      "Third Rate Master", "Second Rate Master", "First Rate Master", "Peak Master", "Three Flowers Gather at the Summit",
      "Five Energies Converging at the Origin", "Ultimate Pinnacle", "Beyond the Path to Heaven (First Stage of Manifestation)",
      "Treading Heaven Beyond the Path (Second Stage of Manifestation)", "Beyond Treading Heavens (Third Stage of Manifestation)",
      "Fourth Stage of Manifestation", "Fifth Stage of Manifestation", "Qi Gathering", "Qi Refining",
      "Qi Building", "Core Formation", "Nascent Soul", "Heavenly Being", "Middle Boundary: Four Pillars",
      "Middle Boundary: Integration", "Middle Boundary: Star Shattering", "Middle Boundary: Star Rebirth",
      "Middle Boundary: Entering Nirvana", "Great Boundary: True Immortal"
    ];
    const miniStages = ["Early", "Middle", "Late", "Peak"];
    const qiNeeded = [
      [100, 200, 400, 700], [1200, 1800, 2400, 3200], [5000, 7000, 9000, 12000], [20000, 25000, 32000, 40000],
      [60000, 80000, 110000, 150000], [220000, 260000, 300000, 340000], [400000, 500000, 600000, 700000],
      [800000, 900000, 1050000, 1200000], [1500000, 1800000, 2100000, 2500000], [3000000, 3500000, 4000000, 4500000],
      [5000000, 6000000, 7000000, 8000000], [10000000, 12000000, 14000000, 16000000], [20000000, 22000000, 24000000, 26000000],
      [30000000, 35000000, 40000000, 45000000], [50000000, 60000000, 70000000, 80000000],
      [100000000, 120000000, 140000000, 160000000], [200000000, 220000000, 240000000, 260000000],
      [300000000, 350000000, 400000000, 450000000], [500000000, 600000000, 700000000, 800000000],
      [1000000000, 1200000000, 1400000000, 1600000000], [2000000000, 2200000000, 2400000000, 2600000000],
      [3000000000, 3500000000, 4000000000, 4500000000], [5000000000, 6000000000, 7000000000, 8000000000],
      [10000000000, 12000000000, 14000000000, 16000000000]
    ];

    // ==== Life Actions ====
    document.getElementById('studyBtn').onclick = function() {
      if (player.wealth >= 5) {
        player.wealth -= 5; player.talent += 1;
        eventMsg.textContent = "You studied hard! Talent increased.";
        addWorldNews("Player studied. Talent increased.");
      } else {
        eventMsg.textContent = "Not enough wealth to study.";
      }
      updateUI();
    };
    document.getElementById('trainBtn').onclick = function() {
      player.health = Math.max(player.health - 3, 0); player.qiPerSec += player.talent;
      eventMsg.textContent = "You trained. Qi/sec increased by your talent.";
      addWorldNews("Player trained. Qi/sec increased.");
      updateUI();
    };
    document.getElementById('workBtn').onclick = function() {
      player.wealth += 15; player.spiritStones += 4; player.health = Math.max(player.health - 2, 0);
      eventMsg.textContent = "You worked and earned money and Spirit Stones.";
      addWorldNews("Player worked. Wealth and Spirit Stones increased.");
      updateUI();
    };
    document.getElementById('restBtn').onclick = function() {
      player.health = Math.min(player.health + 6, 100);
      eventMsg.textContent = "You rested. Health restored.";
      addWorldNews("Player rested. Health restored.");
      updateUI();
    };
    document.getElementById('meetBtn').onclick = function() {
      let unknowns = npcPool.filter(npc=>!knownNPCs.some(k=>k.id===npc.id));
      if (unknowns.length > 0) {
        let npc = randomFrom(unknowns);
        knownNPCs.push(npc);
        player.relationships += 1;
        eventMsg.textContent = `You met ${npc.name}, a ${npc.label}. They are now in your life.`;
        npc.history.push(`Met player (+7)`);
        addWorldNews(`Player met ${npc.name}, a ${npc.label}.`);
      } else {
        eventMsg.textContent = "You have met all possible NPCs for this generation.";
      }
      updateUI();
    };
    document.getElementById('cultivateBtn').onclick = function() {
      player.health = Math.max(player.health - 1, 0); player.qiPerSec += Math.floor(player.talent/2);
      eventMsg.textContent = "You meditate, Qi/sec rises.";
      addWorldNews("Player meditated. Qi/sec rises.");
      updateUI();
    };

    // ==== Advancement logic ====
    advanceBtn.onclick = function() {
      let nextQiNeeded = qiNeeded[player.realmIndex]?.[player.miniStageIndex] || 0;
      if (player.qi >= nextQiNeeded) {
        if (player.miniStageIndex === miniStages.length-1) {
          player.qiPerSec += 5 * (player.realmIndex+1);
          player.miniStageIndex = 0;
          player.realmIndex++;
          player.spiritStones += 3 * (player.realmIndex);
          eventMsg.textContent = `Broke through to ${mainRealms[player.realmIndex] || "the peak!"} and gained Spirit Stones!`;
          addWorldNews(`Player broke through to ${mainRealms[player.realmIndex] || "the peak!"}`, true);
        } else {
          player.miniStageIndex++;
          player.qiPerSec += 2 * (player.miniStageIndex+1);
          eventMsg.textContent = `Advanced to ${miniStages[player.miniStageIndex]} Stage of ${mainRealms[player.realmIndex]}`;
          addWorldNews(`Player advanced to ${miniStages[player.miniStageIndex]} Stage of ${mainRealms[player.realmIndex]}`);
        }
        updateUI();
      }
    };

    // ==== Relationships Panel ====
    relationshipBtn.onclick = function() {
      npcPanel.style.display = "block";
      renderKnownNpcPanel();
    };
    closeNpcPanelBtn.onclick = function() {
      npcPanel.style.display = "none";
    };
    function renderKnownNpcPanel() {
      knownNpcListDiv.innerHTML = knownNPCs.length > 0 ?
        knownNPCs.map(npc => {
          let barWidth = Math.floor(npc.relationship/100*80);
          let barColor = npc.relationship>80 ? "#70e3e3" : npc.relationship>60 ? "#ffd86b" : npc.relationship>40 ? "#e3a95f" : "#f86e6e";
          let marriedTxt = npc.married?"💍":"";
          let spouseTxt = npc.married && npc.spouseId==="player"?" (Married to you)":"";
          let actions = `
            <div class="npc-actions">
              <button onclick="window.npcActionById('${npc.id}','talk')" class="active">Talk</button>
              <button onclick="window.npcActionById('${npc.id}','gift')" class="active">Gift</button>
              <button onclick="window.npcActionById('${npc.id}','duel')" class="active">Duel</button>
              <button onclick="window.npcActionById('${npc.id}','train')" class="active">Train</button>
              <button onclick="window.npcActionById('${npc.id}','befriend')" class="active">Befriend</button>
              <button onclick="window.npcActionById('${npc.id}','date')" class="active">Date</button>
              <button onclick="window.npcActionById('${npc.id}','marry')" class="active">Marry</button>
              <button onclick="window.npcActionById('${npc.id}','breakup')" class="active">Breakup</button>
              <button onclick="window.npcActionById('${npc.id}','disown')" class="active">Disown</button>
              <button onclick="window.npcActionById('${npc.id}','mentor')" class="active">Mentor</button>
              <button onclick="window.npcActionById('${npc.id}','adopt')" class="active">Adopt</button>
            </div>
          `;
          return `
            <div class="npc-panel ${npc.color}">
              <strong>${npc.label}:</strong> ${npc.name} ${marriedTxt}${spouseTxt}<br>
              <span class="npc-details">
                Trait: ${npc.trait} | Age: ${npc.age} | Talent: ${npc.talent} <br>
                Realm: ${mainRealms[npc.realmIndex] || "Peak"} | Stage: ${miniStages[npc.miniStageIndex] || ""} <br>
                Family: ${npc.family} | Affiliation: ${npc.affiliation}<br>
                Relationship: <span class="npc-bar"><span class="npc-bar-inner" style="width:${barWidth}px;background:${barColor};display:inline-block;"></span></span> ${npc.relationship}
                ${npc.alive ? "" : " <em>(eliminated)</em>"}
                <br>
                ${actions}
                <br>
                <small>Recent: ${npc.history.slice(-3).join("; ")}</small>
              </span>
            </div>
          `;
        }).join("") : `<div>No NPCs met yet.</div>`;
    }

    window.npcActionById = function(npcId,action) {
      let npc = knownNPCs.find(n=>n.id===npcId);
      if (npc) npcAction(npc,action);
    };

    function npcAction(npc, action) {
      let msg = "";
      switch(action) {
        case "talk":
          npc.relationship = clamp(npc.relationship+5,0,100);
          msg = `You talked with ${npc.name}. Relationship improved!`;
          npc.history.push("Talked (+5)");
          addWorldNews(`Player talked with ${npc.name}. Relationship improved.`);
          break;
        case "gift":
          if (player.spiritStones >= 10) {
            player.spiritStones -= 10;
            npc.relationship = clamp(npc.relationship+15,0,100);
            msg = `You gave a gift (10 Spirit Stones) to ${npc.name}. Relationship greatly improved!`;
            npc.history.push("Gifted (+15)");
            addWorldNews(`Player gifted ${npc.name} with Spirit Stones.`);
          } else {
            msg = "Not enough Spirit Stones to buy a gift.";
          }
          break;
        case "duel":
          if (Math.random()<0.5) {
            npc.relationship = clamp(npc.relationship-10,0,100);
            msg = `You lost the duel! ${npc.name} looks down on you.`;
            npc.history.push("Lost duel (-10)");
            addWorldNews(`Player lost a duel against ${npc.name}.`);
          } else {
            npc.relationship = clamp(npc.relationship+8,0,100);
            msg = `You won the duel! ${npc.name} respects you more.`;
            npc.history.push("Won duel (+8)");
            addWorldNews(`Player won a duel against ${npc.name}.`);
          }
          break;
        case "train":
          if (player.spiritStones >= 6) {
            player.spiritStones -= 6;
            npc.relationship = clamp(npc.relationship+3,0,100);
            msg = `You trained with ${npc.name} (spent Spirit Stones). Relationship increased.`;
            npc.history.push("Trained (+3)");
            addWorldNews(`Player trained with ${npc.name}. Relationship increased.`);
          } else {
            msg = "Not enough Spirit Stones to train.";
          }
          break;
        case "befriend":
          if (npc.relationship>75 && npc.type!=="ally") {
            npc.type="ally"; npc.label="Ally"; npc.color="npc-ally";
            msg = `${npc.name} has become your close ally!`;
            npc.history.push("Became Ally");
            addWorldNews(`Player befriended ${npc.name}. Now allies.`);
          } else {
            msg = "Relationship not high enough to become allies.";
          }
          break;
        case "date":
          if (npc.type==="love" && !npc.married && npc.relationship>65) {
            npc.relationship = clamp(npc.relationship+8,0,100);
            msg = `You went on a date with ${npc.name}.`;
            npc.history.push("Dated (+8)");
            addWorldNews(`Player dated ${npc.name}.`);
          } else {
            msg = "Cannot date this NPC.";
          }
          break;
        case "marry":
          if (npc.type==="love" && !npc.married && npc.relationship>85) {
            npc.married = true;
            npc.spouseId = "player";
            msg = `You married ${npc.name}!`;
            npc.history.push("Married player");
            addWorldNews(`Player married ${npc.name}!`);
          } else {
            msg = "Relationship not high enough to marry.";
          }
          break;
        case "breakup":
          if (npc.type==="love" && npc.married) {
            npc.married = false;
            npc.spouseId = null;
            npc.relationship = clamp(npc.relationship-35,0,100);
            msg = `You broke up with ${npc.name}.`;
            npc.history.push("Broke up (-35)");
            addWorldNews(`Player broke up with ${npc.name}.`);
          } else {
            msg = "Cannot break up.";
          }
          break;
        case "disown":
          if (npc.type==="family" && npc.relationship<20) {
            npc.type="rival"; npc.label="Rival"; npc.color="npc-rival";
            msg = `You have disowned ${npc.name}. They become a rival!`;
            npc.history.push("Disowned (becomes rival)");
            addWorldNews(`Player disowned ${npc.name}. Now a rival.`);
          } else {
            msg = "Cannot disown this NPC.";
          }
          break;
        case "mentor":
          if (npc.type==="mentor" && npc.relationship>70) {
            if (player.spiritStones >= 12) {
              player.spiritStones -= 12;
              player.talent += 1;
              msg = `${npc.name} imparted wisdom (for Spirit Stones). Your talent increased!`;
              npc.history.push("Mentored player (+talent)");
              addWorldNews(`${npc.name} mentored player. Talent increased.`);
            } else {
              msg = "Not enough Spirit Stones for mentor's teaching.";
            }
          } else {
            msg = "Mentor relationship not high enough.";
          }
          break;
        case "adopt":
          if (npc.type==="disciple" && npc.relationship>70) {
            npc.type="family"; npc.label="Family"; npc.color="npc-family";
            msg = `You adopted ${npc.name} as family.`;
            npc.history.push("Adopted (family)");
            addWorldNews(`Player adopted ${npc.name} into family.`);
          } else {
            msg = "Cannot adopt this NPC.";
          }
          break;
      }
      eventMsg.textContent = msg;
      updateUI();
    }

    // ==== NPC Trouble & World Threats Integration ====
    setInterval(function() {
      // NPCs cause trouble
      if (knownNPCs.length > 0 && Math.random() < 0.11) {
        let npc = randomFrom(knownNPCs.filter(n => n.alive && (n.type==="enemy"||n.type==="boss")));
        if (!npc) return;
        let actions = [
          "started a fight", "betrayed their faction", "stole Spirit Stones", "provoked a duel", 
          "spread chaos", "sabotaged defenses", "assassinated a rival", "incited rebellion", "robbed a cultivator"
        ];
        let action = randomFrom(actions);
        addWorldNews(`${npc.name} (${npc.label}) ${action} in ${npc.location}!`, true);
        // Affect player or random NPC
        if (action === "stole Spirit Stones" && player.spiritStones > 0) {
          let loss = Math.min(player.spiritStones, Math.floor(Math.random()*6)+3);
          player.spiritStones -= loss;
          addWorldNews(`${npc.name} stole ${loss} of your Spirit Stones!`, true);
        }
      }
      // Rare world threat event
      if (knownNPCs.length > 0 && Math.random() < 0.02) {
        let npc = randomFrom(knownNPCs.filter(n => n.alive && n.type === "boss"));
        if (!npc) return;
        let threats = [
          "declared war on all kingdoms", "summoned a demon army", "threatens the world with disaster",
          "tries to dominate the cultivation world", "initiates world tribulation", "calls for universal slaughter"
        ];
        let threat = randomFrom(threats);
        addWorldNews(`Major Threat! ${npc.name} (${npc.affiliation}) ${threat}!`, true);
        npc.relationship = Math.max(npc.relationship - 10, 0);
      }
    }, 8000);

    // ==== UI Update ====
    function updateUI() {
      ageDisplay.textContent = player.age;
      healthDisplay.textContent = player.health;
      talentDisplay.textContent = player.talent;
      relDisplay.textContent = player.relationships;
      wealthDisplay.textContent = player.wealth;
      spiritStoneDisplay.textContent = player.spiritStones;
      qiDisplay.textContent = Math.floor(player.qi);
      qpsDisplay.textContent = Math.floor(player.qiPerSec);
      infamyDisplay.textContent = player.infamy;
      realmDisplay.textContent = mainRealms[player.realmIndex] || "Peak";
      miniStageDisplay.textContent = miniStages[player.miniStageIndex] || "";
      let agePct = clamp((player.age-16)/84,0,1);
      ageBar.style.width = (180*agePct)+"px";
      ageBarLabel.textContent = `${player.age} yrs`;
      let healthPct = clamp(player.health/100,0,1);
      healthBar.style.width = (180*healthPct)+"px";
      healthBarLabel.textContent = `${player.health}`;
      let relPct = clamp(player.relationships/20,0,1);
      relBar.style.width = (180*relPct)+"px";
      relBarLabel.textContent = `${player.relationships}`;
      let nextQiNeeded = qiNeeded[player.realmIndex]?.[player.miniStageIndex] || 100;
      let qiPct = clamp(player.qi/nextQiNeeded,0,1);
      qiBar.style.width = (180*qiPct)+"px";
      qiBarLabel.textContent = `${Math.floor(player.qi)} / ${nextQiNeeded}`;
      if (player.kingdom) {
        kingdomInfoPanel.innerHTML = `
          <div class="kingdom-info">
            <strong>Your Kingdom:</strong> ${player.kingdom.name} (${player.kingdom.location})<br>
            Wealth: ${player.kingdom.resources.wealth} | Qi: ${player.kingdom.resources.qi} | Troops: ${player.kingdom.troops}
          </div>
        `;
      } else {
        kingdomInfoPanel.innerHTML = "";
      }
      renderKnownNpcPanel();
    }
    updateUI();
</script>
